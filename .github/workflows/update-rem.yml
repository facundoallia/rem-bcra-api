name: Actualizar REM BCRA

on:
  schedule:
    # Ejecutar diariamente a las 12:00 UTC (9:00 AM Argentina)
    # Solo durante los primeros 7 d√≠as del mes (cuando publica el BCRA)
    - cron: '0 12 1-7 * *'
  
  workflow_dispatch:  # Permitir ejecuci√≥n manual
  
  push:
    branches: [ main ]
    paths:
      - 'api REM/**'
      - '.github/workflows/update-rem.yml'

jobs:
  update-rem:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repositorio
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Instalar dependencias
      run: |
        pip install pandas openpyxl requests
        npm install -g wrangler
    
    - name: Descargar REM desde BCRA
      id: download
      run: |
        cd "api REM"
        python "download REM"
        exit_code=$?
        echo "download_status=$exit_code" >> $GITHUB_OUTPUT
        if [ $exit_code -eq 1 ]; then
          echo "‚ÑπÔ∏è Archivo ya actualizado - no hay cambios"
          exit 0
        elif [ $exit_code -eq 2 ]; then
          echo "‚ùå Error en descarga"
          exit 1
        fi
        echo "‚úÖ Archivo nuevo descargado"
    
    - name: Parsear Excel a JSON
      if: steps.download.outputs.download_status == '0'
      id: parse
      run: |
        cd "api REM"
        python "read REM.py"
        echo "parse_status=$?" >> $GITHUB_OUTPUT
      continue-on-error: true
    
    - name: Validar datos generados
      if: steps.parse.outputs.parse_status == '0'
      id: validate
      run: |
        cd "api REM"
        python validate_output.py
        echo "validate_status=$?" >> $GITHUB_OUTPUT
      continue-on-error: true
    
    - name: Deploy a Cloudflare R2
      if: steps.parse.outputs.parse_status == '0'
      id: deploy
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      run: |
        cd "api REM"
        python deploy_with_wrangler.py
        echo "deploy_status=$?" >> $GITHUB_OUTPUT
    
    - name: Verificar cambios
      id: changes
      run: |
        cd "api REM/data"
        if git diff --quiet *.json 2>/dev/null; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "No hay cambios en los datos"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Hay cambios en los datos"
        fi
    
    - name: Commit metadata (opcional)
      if: steps.changes.outputs.has_changes == 'true' && steps.deploy.outputs.deploy_status == '0'
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        git add "api REM/data/_metadata.json"
        git commit -m "ü§ñ Actualizar metadata REM - $(date -u +%Y-%m-%d)" || echo "No metadata changes"
        git push || echo "Nothing to push"
    
    - name: Crear issue si falla
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const title = '‚ùå Fallo en actualizaci√≥n REM';
          const body = `
          ### Detalles del fallo
          
          - **Workflow**: ${{ github.workflow }}
          - **Run ID**: ${{ github.run_id }}
          - **Fecha**: ${new Date().toISOString()}
          
          #### Estado de los pasos:
          - Descarga: ${{ steps.download.outputs.download_status || 'N/A' }}
          - Parseo: ${{ steps.parse.outputs.parse_status || 'N/A' }}
          - Validaci√≥n: ${{ steps.validate.outputs.validate_status || 'N/A' }}
          - Deploy: ${{ steps.deploy.outputs.deploy_status || 'N/A' }}
          
          [Ver logs del workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['automation', 'bug']
          });
    
    - name: Subir artefactos en caso de fallo
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: rem-data-failed-${{ github.run_number }}
        path: |
          api REM/data/*.json
          api REM/data/*.xlsx
        retention-days: 30
